#!/usr/bin/env bash

VERSION="$1"

if [ -z "$VERSION" ]; then
  bunvm_msg_error "Usage: bunvm use <version | alias>"
  return 1
fi

# resolve alias if it exists
if [ -f "$BUNVM_ETC/aliases" ]; then
  MATCH="$(grep -E "^$VERSION=" "$BUNVM_ETC/aliases" 2>/dev/null | head -n 1 || true)"
  if [ -n "$MATCH" ]; then
    VERSION="${MATCH#*=}"
  fi
fi

TARGET="$BUNVM_VERSIONS/bun-$VERSION"

if [ ! -d "$TARGET" ]; then
  bunvm_msg_error "Version $VERSION is not installed."
  return 1
fi

if [ ! -f "$TARGET/bin/bun" ]; then
  bunvm_msg_error "Corrupted installation: missing $TARGET/bin/bun"
  return 1
fi

# Activate in current shell
case ":$PATH:" in
  *":$TARGET/bin:"*) ;;
  *) export PATH="$TARGET/bin:$PATH" ;;
esac

# Persist as default version
echo "$VERSION" > "$BUNVM_ETC/current"

bunvm_msg_success "Now using Bun $VERSION"
bunvm_msg_info "Version saved as default for future shells"
