#!/usr/bin/env bash

MODE="$1"

bunvm_msg "ðŸ”Ž Consultando versiones de Bunâ€¦"

# Leer versiÃ³n actual
CURRENT=""
if [ -f "$BUNVM_ETC/current" ]; then
    CURRENT=$(cat "$BUNVM_ETC/current")
fi

# Obtener releases remotos desde GitHub
get_remote_versions() {
  curl -fsSL "https://api.github.com/repos/oven-sh/bun/releases" \
    | grep '"tag_name"' \
    | sed 's/.*"bun-v//;s/".*//'
}

# Obtener versiones instaladas localmente
get_local_versions() {
  for v in "$BUNVM_VERSIONS"/bun-*; do
    [ -d "$v" ] && basename "$v" | sed 's/^bun-//'
  done
}

LOCAL_VERSIONS_ARRAY=($(get_local_versions))
REMOTE_VERSIONS=""

# Si no es --local, tambiÃ©n consultamos remoto
if [ "$MODE" != "--local" ]; then
  REMOTE_VERSIONS=$(get_remote_versions)
fi

bunvm_msg ""
bunvm_msg "================================================================================"
bunvm_msg " Available Bun Versions"
bunvm_msg "================================================================================"
printf " %-10s | %-12s | %-3s | %s\n" "Version" "Status" "Use" "Path"
bunvm_msg "--------------------------------------------------------------------------------"

print_row() {
  local VER="$1"
  local STATUS="$2"
  local USE="$3"
  local PATH="$4"

  printf " %-10s | %-12s | %-3s | %s\n" "$VER" "$STATUS" "$USE" "$PATH"
}

#
# SOLO LOCAL
#
if [ "$MODE" = "--local" ]; then
    for VER in "${LOCAL_VERSIONS_ARRAY[@]}"; do
        STATUS="installed"
        USE="-"
        PATH="$BUNVM_VERSIONS/bun-$VER"

        if [ "$VER" = "$CURRENT" ]; then
            STATUS="installed*"
            USE="ðŸ‘‰"
        fi

        print_row "$VER" "$STATUS" "$USE" "$PATH"
    done

    bunvm_msg "--------------------------------------------------------------------------------"
    bunvm_msg "ðŸ‘‰ indicates the version currently in use."
    exit 0
fi

#
# REMOTO + LOCAL (similar a SDKMAN)
#
for VER in $REMOTE_VERSIONS; do
    STATUS="available"
    USE="-"
    PATH="-"

    # verificar si estÃ¡ instalada
    for LVER in "${LOCAL_VERSIONS_ARRAY[@]}"; do
        if [ "$VER" = "$LVER" ]; then
            STATUS="installed"
            PATH="$BUNVM_VERSIONS/bun-$VER"
        fi
    done

    # marcar actual
    if [ "$VER" = "$CURRENT" ]; then
        STATUS="installed*"
        USE="ðŸ‘‰"
        PATH="$BUNVM_VERSIONS/bun-$VER"
    fi

    print_row "$VER" "$STATUS" "$USE" "$PATH"
done

bunvm_msg "--------------------------------------------------------------------------------"
bunvm_msg "ðŸ‘‰ indicates the version currently in use."
