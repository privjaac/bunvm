#!/usr/bin/env bash

# bunvm list [--local]
MODE="$1"

bunvm_msg "ðŸ”Ž Consultando versiones de Bunâ€¦"

# VersiÃ³n actual
CURRENT=""
if [ -f "$BUNVM_ETC/current" ]; then
  CURRENT="$(cat "$BUNVM_ETC/current")"
fi

# ---------------------------
# Helpers
# ---------------------------

get_remote_versions() {
  curl -fsSL "https://api.github.com/repos/oven-sh/bun/releases" 2>/dev/null \
    | grep '"tag_name"' \
    | sed 's/.*"bun-v//;s/".*//'
}

get_local_versions() {
  [ -d "$BUNVM_VERSIONS" ] || return 0
  find "$BUNVM_VERSIONS" -maxdepth 1 -type d -name 'bun-*' 2>/dev/null \
    | sed 's#.*/bun-##'
}

print_header() {
  bunvm_msg ""
  bunvm_msg "================================================================================"
  bunvm_msg " Available Bun Versions"
  bunvm_msg "================================================================================"
  printf " %-10s | %-12s | %-3s | %s\n" "Version" "Status" "Use" "Path"
  bunvm_msg "--------------------------------------------------------------------------------"
}

print_row() {
  printf " %-10s | %-12s | %-3s | %s\n" "$1" "$2" "$3" "$4"
}

print_footer() {
  bunvm_msg "--------------------------------------------------------------------------------"
  bunvm_msg "* indicates the version currently in use."
}

# ---------------------------
# Load local versions
# ---------------------------

LOCAL_VERSIONS=()
while IFS= read -r v; do
  [ -n "$v" ] && LOCAL_VERSIONS+=("$v")
done <<EOF
$(get_local_versions)
EOF

REMOTE_VERSIONS=""
[ "$MODE" != "--local" ] && REMOTE_VERSIONS="$(get_remote_versions)"

print_header

# ---------------------------
# Only local
# ---------------------------
if [ "$MODE" = "--local" ]; then
  if [ "${#LOCAL_VERSIONS[@]}" -eq 0 ]; then
    bunvm_msg_info "No hay versiones instaladas aÃºn."
    print_footer
    return 0
  fi

  for VER in "${LOCAL_VERSIONS[@]}"; do
    STATUS="installed"
    USE=""
    BIN_PATH="$BUNVM_VERSIONS/bun-$VER"

    if [ "$VER" = "$CURRENT" ]; then
      STATUS="installed*"
      USE="*"
    fi

    print_row "$VER" "$STATUS" "$USE" "$BIN_PATH"
  done

  print_footer
  return 0
fi

# ---------------------------
# Remote + local
# ---------------------------

[ -z "$REMOTE_VERSIONS" ] && bunvm_msg_error "No se pudo consultar GitHub."

echo "$REMOTE_VERSIONS" | while IFS= read -r VER; do
  [ -z "$VER" ] && continue

  STATUS="available"
  USE=""
  BIN_PATH="-"

  for LVER in "${LOCAL_VERSIONS[@]}"; do
    if [ "$VER" = "$LVER" ]; then
      STATUS="installed"
      BIN_PATH="$BUNVM_VERSIONS/bun-$VER"
      break
    fi
  done

  if [ "$VER" = "$CURRENT" ]; then
    STATUS="installed*"
    USE="*"
    BIN_PATH="$BUNVM_VERSIONS/bun-$VER"
  fi

  print_row "$VER" "$STATUS" "$USE" "$BIN_PATH"
done

print_footer
