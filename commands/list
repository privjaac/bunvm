#!/usr/bin/env bash

# bunvm list [--local]
MODE="$1"

bunvm_msg "ðŸ”Ž Consultando versiones de Bunâ€¦"

# VersiÃ³n actual (si existe)
CURRENT=""
if [ -f "$BUNVM_ETC/current" ]; then
  CURRENT="$(cat "$BUNVM_ETC/current")"
fi

# ---------------------------
# Helpers
# ---------------------------

get_remote_versions() {
  # Devuelve la lista de tags bun-vX.Y.Z como X.Y.Z (una por lÃ­nea)
  curl -fsSL "https://api.github.com/repos/oven-sh/bun/releases" 2>/dev/null \
    | grep '"tag_name"' \
    | sed 's/.*"bun-v//;s/".*//' 
}

get_local_versions() {
  # Evitar errores en zsh cuando no hay coincidencias
  if [ ! -d "$BUNVM_VERSIONS" ]; then
    return
  fi

  find "$BUNVM_VERSIONS" -maxdepth 1 -type d -name 'bun-*' 2>/dev/null \
    | sed 's#.*/bun-##'
}

print_header() {
  bunvm_msg ""
  bunvm_msg "================================================================================"
  bunvm_msg " Available Bun Versions"
  bunvm_msg "================================================================================"
  printf " %-10s | %-12s | %-3s | %s\n" "Version" "Status" "Use" "Path"
  bunvm_msg "--------------------------------------------------------------------------------"
}

print_row() {
  # $1 = version, $2 = status, $3 = use, $4 = path
  printf " %-10s | %-12s | %-3s | %s\n" "$1" "$2" "$3" "$4"
}

print_footer() {
  bunvm_msg "--------------------------------------------------------------------------------"
  bunvm_msg "* indicates the version currently in use."
}

# ---------------------------
# Cargar datos
# ---------------------------

LOCAL_VERSIONS_ARRAY=()
while IFS= read -r v; do
  [ -n "$v" ] && LOCAL_VERSIONS_ARRAY+=("$v")
done <<EOF
$(get_local_versions)
EOF

REMOTE_VERSIONS=""
if [ "$MODE" != "--local" ]; then
  REMOTE_VERSIONS="$(get_remote_versions)"
fi

print_header

# ---------------------------
# Solo local
# ---------------------------
if [ "$MODE" = "--local" ]; then
  if [ "${#LOCAL_VERSIONS_ARRAY[@]}" -eq 0 ]; then
    bunvm_msg_info "No hay versiones instaladas aÃºn."
    print_footer
    return 1
  fi

  for VER in "${LOCAL_VERSIONS_ARRAY[@]}"; do
    STATUS="installed"
    USE=""
    PATH="$BUNVM_VERSIONS/bun-$VER"

    if [ "$VER" = "$CURRENT" ]; then
      STATUS="installed*"
      USE="*"
    fi

    print_row "$VER" "$STATUS" "$USE" "$PATH"
  done

  print_footer
  return 1
fi

# ---------------------------
# Remoto + local
# ---------------------------

if [ -z "$REMOTE_VERSIONS" ]; then
  bunvm_msg_error "No se pudo obtener la lista remota de versiones desde GitHub."
  # como fallback mostramos solo locales
  if [ "${#LOCAL_VERSIONS_ARRAY[@]}" -eq 0 ]; then
    bunvm_msg_info "Tampoco hay versiones locales instaladas."
    print_footer
    return 1
  fi

  for VER in "${LOCAL_VERSIONS_ARRAY[@]}"; do
    STATUS="installed"
    USE=""
    PATH="$BUNVM_VERSIONS/bun-$VER"

    if [ "$VER" = "$CURRENT" ]; then
      STATUS="installed*"
      USE="*"
    fi

    print_row "$VER" "$STATUS" "$USE" "$PATH"
  done

  print_footer
  return 1
fi

# Recorrer versiones remotas y marcar estado/local/actual
echo "$REMOTE_VERSIONS" | while IFS= read -r VER; do
  [ -z "$VER" ] && continue

  STATUS="available"
  USE=""
  PATH="-"

  for LVER in "${LOCAL_VERSIONS_ARRAY[@]}"; do
    if [ "$VER" = "$LVER" ]; then
      STATUS="installed"
      PATH="$BUNVM_VERSIONS/bun-$VER"
      break
    fi
  done

  if [ "$VER" = "$CURRENT" ]; then
    STATUS="installed*"
    USE="*"
    PATH="$BUNVM_VERSIONS/bun-$VER"
  fi

  print_row "$VER" "$STATUS" "$USE" "$PATH"
done

print_footer
