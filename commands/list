#!/usr/bin/env bash

# bunvm list [--local]
MODE="$1"

bunvm_msg "ðŸ”Ž Querying Bun versionsâ€¦"

# Current version (if exists)
CURRENT=""
if [ -f "$BUNVM_ETC/current" ]; then
  CURRENT="$(cat "$BUNVM_ETC/current")"
fi

# ---------------------------
# Helpers
# ---------------------------

get_remote_versions() {
  # Returns the list of bun-vX.Y.Z tags as X.Y.Z (one per line)
  curl -fsSL "https://api.github.com/repos/oven-sh/bun/releases" 2>/dev/null \
    | grep '"tag_name"' \
    | sed 's/.*"bun-v//;s/".*//' 
}

get_local_versions() {
  # Avoid errors in zsh when there are no matches
  if [ ! -d "$BUNVM_VERSIONS" ]; then
    return
  fi

  find "$BUNVM_VERSIONS" -maxdepth 1 -type d -name 'bun-*' 2>/dev/null \
    | sed 's#.*/bun-##'
}

print_header() {
  bunvm_msg ""
  bunvm_msg "================================================================================"
  bunvm_msg " Available Bun Versions"
  bunvm_msg "================================================================================"
  printf " %-10s | %-12s | %-3s | %s\n" "Version" "Status" "Use" "Install Path"
  bunvm_msg "--------------------------------------------------------------------------------"
}

print_row() {
  # $1 = version, $2 = status, $3 = use, $4 = install_path
  printf " %-10s | %-12s | %-3s | %s\n" "$1" "$2" "$3" "$4"
}

print_footer() {
  bunvm_msg "--------------------------------------------------------------------------------"
  bunvm_msg "* indicates the version currently in use."
}

# ---------------------------
# Load data
# ---------------------------

LOCAL_VERSIONS_ARRAY=()
while IFS= read -r v; do
  [ -n "$v" ] && LOCAL_VERSIONS_ARRAY+=("$v")
done <<EOF
$(get_local_versions)
EOF

REMOTE_VERSIONS=""
if [ "$MODE" != "--local" ]; then
  REMOTE_VERSIONS="$(get_remote_versions)"
fi

print_header

# ---------------------------
# Local only
# ---------------------------
if [ "$MODE" = "--local" ]; then
  if [ "${#LOCAL_VERSIONS_ARRAY[@]}" -eq 0 ]; then
    bunvm_msg_info "No versions installed yet."
    print_footer
    return 0
  fi

  for VER in "${LOCAL_VERSIONS_ARRAY[@]}"; do
    STATUS="installed"
    USE=""
    INSTALL_PATH="$BUNVM_VERSIONS/bun-$VER"

    if [ "$VER" = "$CURRENT" ]; then
      STATUS="installed*"
      USE="*"
    fi

    print_row "$VER" "$STATUS" "$USE" "$INSTALL_PATH"
  done

  print_footer
  return 0
fi

# ---------------------------
# Remote + local
# ---------------------------

if [ -z "$REMOTE_VERSIONS" ]; then
  bunvm_msg_error "Could not get remote version list from GitHub."
  # as fallback show only local versions
  if [ "${#LOCAL_VERSIONS_ARRAY[@]}" -eq 0 ]; then
    bunvm_msg_info "No local versions installed either."
    print_footer
    return 1
  fi

  for VER in "${LOCAL_VERSIONS_ARRAY[@]}"; do
    STATUS="installed"
    USE=""
    INSTALL_PATH="$BUNVM_VERSIONS/bun-$VER"

    if [ "$VER" = "$CURRENT" ]; then
      STATUS="installed*"
      USE="*"
    fi

    print_row "$VER" "$STATUS" "$USE" "$INSTALL_PATH"
  done

  print_footer
  return 0
fi

# Iterate through remote versions and mark status/local/current
echo "$REMOTE_VERSIONS" | while IFS= read -r VER; do
  [ -z "$VER" ] && continue

  STATUS="available"
  USE=""
  INSTALL_PATH="-"

  for LVER in "${LOCAL_VERSIONS_ARRAY[@]}"; do
    if [ "$VER" = "$LVER" ]; then
      STATUS="installed"
      INSTALL_PATH="$BUNVM_VERSIONS/bun-$VER"
      break
    fi
  done

  if [ "$VER" = "$CURRENT" ]; then
    STATUS="installed*"
    USE="*"
    INSTALL_PATH="$BUNVM_VERSIONS/bun-$VER"
  fi

  print_row "$VER" "$STATUS" "$USE" "$INSTALL_PATH"
done

print_footer
